<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moovit Pay</title>
    <link rel="stylesheet" href="variables.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="qr-scanner.min.js" type="text/javascript"></script>
    <meta name="apple-mobile-web-app-capable" content="yes" /> 
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ptma/Leaflet.Measure@master/src/leaflet.measure.css" />
<script src="https://cdn.jsdelivr.net/gh/ptma/Leaflet.Measure@master/src/leaflet.measure.js"></script>

</head>
<body>
    <div id="secondscreen" style="display: none;">
      <div id="reader"></div>


    </div>
    <div id="thirdscreen" >
        <div id="top">
            <p>אשף הנסיעות לקביעת תעריף</p>
            <svg width="100px" height="100px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="backarrowsvg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289L16.7071 11.2929C17.0976 11.6834 17.0976 12.3166 16.7071 12.7071L9.70711 19.7071C9.31658 20.0976 8.68342 20.0976 8.29289 19.7071C7.90237 19.3166 7.90237 18.6834 8.29289 18.2929L14.5858 12L8.29289 5.70711C7.90237 5.31658 7.90237 4.68342 8.29289 4.29289Z" fill="#000000"/>
            </svg>
        </div>
        <div id="mapbody">
            
            <div id="map" style="height: 300px;"></div>
            <h2>בחר תחנת יעד</h2>
            <div class="busInfo">
                <div class="number">
                    <span id="busStopSelectionNumber">000</span>
                    <svg fill="#000000" width="32px" height="32px" viewBox="-0.5 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.275 19.36c.001-.426.346-.771.772-.772h3.101c.426.001.771.346.772.772-.001.426-.346.771-.772.772h-3.101c-.426-.001-.771-.346-.772-.772zm-6.174 0c-.001.426-.346.771-.772.772h-3.101c-.426-.001-.771-.346-.772-.772.001-.426.346-.771.772-.772h3.101c.426.001.771.346.772.772zm-3.741-17.11h13.727c.499 0 .903.404.903.903l-.462 10.349v.001c0 .499-.404.903-.903.903h-12.8c-.499 0-.903-.404-.903-.903v-.001l-.462-10.349c0-.499.405-.903.904-.903zm17.685 1.944h-1.531v-3.143c-.001-.578-.469-1.047-1.047-1.048h-16.48c-.577.002-1.045.47-1.046 1.047v3.143h-1.474c-.255.001-.461.207-.462.462v3.826c0 .255.207.461.462.462h1.474v15.055h3.845v-2.013h10.865v2.013h3.846v-2.839c.015-.066.024-.142.025-.22v-12h1.531c.255-.001.461-.207.462-.462v-3.826c0-.255-.207-.461-.462-.462z"/></svg>
                </div>
                <span>
                    תל אביב יפו
                </span>
            </div>
            <div id="stopsList">
                <ul id="stops">

                </ul>
            </div>
        </div>
    </div>
    
<script>

buspresets = {
    // kavim: "#03296a",
    kavim:"#8cbcd8",
    metropolin: "#f78f1e",
    egged: "#018369",
    dan:"#205cab"
}


function getDistance(origin, destination) {
    // return distance in meters
    console.log(origin,destination)
    var lon1 = toRadian(origin.longitude),
        lat1 = toRadian(origin.latitude),
        lon2 = toRadian(destination[0]),
        lat2 = toRadian(destination[1]);

    var deltaLat = lat2 - lat1;
    var deltaLon = lon2 - lon1;

    var a = Math.pow(Math.sin(deltaLat/2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(deltaLon/2), 2);
    var c = 2 * Math.asin(Math.sqrt(a));
    var EARTH_RADIUS = 6371;
    return c * EARTH_RADIUS * 1000;
}
function toRadian(degree) {
    return degree*Math.PI/180;
}

const html5QrCode = new Html5Qrcode("reader");
const qrCodeSuccessCallback = (decodedText, decodedResult) => {
    document.getElementById('secondscreen').style.display = "none";
    document.getElementById('thirdscreen').style.display = "block";
};
const config = { fps: 10, qrbox: { width: window.innerWidth-50, height: window.innerHeight-50 } };

// If you want to prefer back camera
html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);

document.getElementById("reader").innerHTML += `<div style="
    position: fixed;bottom: 32vh;width: 100vw;text-align: center;color: white;direction: rtl;font-family: system-ui;z-index:999;" id="help">שימו לב שהקוד ממוקד בתוך המסגרת. <br>הסריקה תתבצע באופן אוטומטי</div>`

function processData(dataX) {
    //for each child that has propeties.class == "Bus Stop"
    for (let i = 0; i < dataX.features.length; i++) {
        if (dataX.features[i].properties.class == "Bus stop") {
            div = document.createElement("li");
            div.className = "stop";
            div.id = dataX.features[i].properties.id;
            div.innerHTML = `<p>${dataX.features[i].properties.name}</p><div id="extender"></div>`;
            div.onclick = function() {
                selectStop(dataX.features[i]);
            }
            div.onclick = function() {
                selectStop(dataX.features[i]);
            }
            document.getElementById("stops").appendChild(div)
        }
    }
}

function selectStop(stop) {
    console.log(stop)
    console.log(getDistance(currentloc,stop.geometry.coordinates))
}


var map = L.map('map').setView([32.0030, 34.8435], 12);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '',
    maxZoom: 18
}).addTo(map);
var locator = map.locate({
    setView:true,
})


map.on('locationfound', function(ev){
currentloc = ev;
console.log(currentloc)
})
// Load GeoJSON data from a file (replace with your actual file path)
var geojsonMarkerOptions = {
    radius: 8,
    fillColor: "#FFFFFF",
    color: "#3388ff",
    weight: 2,
    opacity: 1, 
    fillOpacity: 1,
    stroke:true
};
fetch('data.geojson')
    .then(response => response.json())
    .then(data => {
        processData(data);
        L.geoJSON(data,{
            style: function(feature) {
            console.log(feature.properties.class);
            if (feature.properties.class == "Bus stop") {
                return {
                    geojsonMarkerOptions
                }
            }

        },
        pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions);
        },
        onEachFeature: function (feature, layer) {
            if (feature.properties.class == "Bus stop") {
                layer.on('click', function (e) {
                    selectStop(feature);
                });
            }
            }   
        }).addTo(map);
    });

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moovit Pay</title>
    <link rel="stylesheet" href="variables.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="qr-scanner.min.js" type="text/javascript"></script>
    <meta name="apple-mobile-web-app-capable" content="yes" /> 
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ptma/Leaflet.Measure@master/src/leaflet.measure.css" />
<script src="https://cdn.jsdelivr.net/gh/ptma/Leaflet.Measure@master/src/leaflet.measure.js"></script>

</head>
<body>
    <div id="firstscreen">
        <div id="top" class="noselect" >
            <p>חיפוש הקו</p>
            <svg width="100px" height="100px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="backarrowsvg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289L16.7071 11.2929C17.0976 11.6834 17.0976 12.3166 16.7071 12.7071L9.70711 19.7071C9.31658 20.0976 8.68342 20.0976 8.29289 19.7071C7.90237 19.3166 7.90237 18.6834 8.29289 18.2929L14.5858 12L8.29289 5.70711C7.90237 5.31658 7.90237 4.68342 8.29289 4.29289Z" fill="#c3c3c3c3"/>
            </svg>
        </div>
        <!-- <select>
            <option value="{n:'11500-1-1',c:'kavim'}">קו 500 - קווים</option>
            <option value="{n:'10506-1-0',c:'kavim'}">קו 506 - קווים</option>
            <option value="{n:'11460-1-0',c:'kavim'}">קו 460 - קווים</option>
            <option value="{n:'21032-1-0',c:'kavim'}">קו 32 - קווים</option>
            <option value="{n:'29013-1-7',c:'kavim'}">קו 13 - קווים</option>
            <option value="{n:'11251-1-0',c:'metropolin'}">קו 251 - מטרופולין</option>
            <option value="{n:'14444-1-0',c:'metropolin'}">קו 444 - מטרופולין</option>
        </select> -->
        <input oninput="searchKavim(this.value)" type="text" placeholder="חפש קו על פי עיר (מקום הגעה) ומספר">
        <select id="searchRes">

        </select>
        <button onclick="go()">go</button>
    </div>
    <div id="secondscreen" style="display: none;">
        <div id="top" class="noselect dark" >
            <p>סרוק קוד QR</p>
            <svg width="100px" height="100px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="backarrowsvg" onclick="backtoSelectia()">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289L16.7071 11.2929C17.0976 11.6834 17.0976 12.3166 16.7071 12.7071L9.70711 19.7071C9.31658 20.0976 8.68342 20.0976 8.29289 19.7071C7.90237 19.3166 7.90237 18.6834 8.29289 18.2929L14.5858 12L8.29289 5.70711C7.90237 5.31658 7.90237 4.68342 8.29289 4.29289Z" fill="#000000"/>
            </svg>
        </div>
      <div id="reader"></div>


    </div>
    <div id="thirdscreen"  style="display: none;">
        <div id="top" class="noselect" >
            <p>אשף הנסיעות לקביעת תעריף</p>
            <svg width="100px" height="100px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="backarrowsvg" onclick="backfromStops()">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289L16.7071 11.2929C17.0976 11.6834 17.0976 12.3166 16.7071 12.7071L9.70711 19.7071C9.31658 20.0976 8.68342 20.0976 8.29289 19.7071C7.90237 19.3166 7.90237 18.6834 8.29289 18.2929L14.5858 12L8.29289 5.70711C7.90237 5.31658 7.90237 4.68342 8.29289 4.29289Z" fill="#000000"/>
            </svg>
        </div>
        <div id="mapbody">
            <div id="map" style="height: 300px;"></div>
            <h2 class="noselect">בחר תחנת יעד</h2>
            <div class="busInfo noselect" >
                <div class="number">
                    <span id="busStopSelectionNumber">000</span>
                    <div id="busIcon">
                        <svg fill="#000000" width="32px" height="32px" viewBox="-0.5 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.275 19.36c.001-.426.346-.771.772-.772h3.101c.426.001.771.346.772.772-.001.426-.346.771-.772.772h-3.101c-.426-.001-.771-.346-.772-.772zm-6.174 0c-.001.426-.346.771-.772.772h-3.101c-.426-.001-.771-.346-.772-.772.001-.426.346-.771.772-.772h3.101c.426.001.771.346.772.772zm-3.741-17.11h13.727c.499 0 .903.404.903.903l-.462 10.349v.001c0 .499-.404.903-.903.903h-12.8c-.499 0-.903-.404-.903-.903v-.001l-.462-10.349c0-.499.405-.903.904-.903zm17.685 1.944h-1.531v-3.143c-.001-.578-.469-1.047-1.047-1.048h-16.48c-.577.002-1.045.47-1.046 1.047v3.143h-1.474c-.255.001-.461.207-.462.462v3.826c0 .255.207.461.462.462h1.474v15.055h3.845v-2.013h10.865v2.013h3.846v-2.839c.015-.066.024-.142.025-.22v-12h1.531c.255-.001.461-.207.462-.462v-3.826c0-.255-.207-.461-.462-.462z"/></svg>
                    </div>
                </div>
                <span>
                    תל אביב יפו
                </span>
            </div>
            <div id="stopsList">
                <ul id="stops"></ul>
            </div>
        </div>
    </div>

    <div id="fourthscreen" style="display: none;">
        <div id="top" class="noselect">
            <p>בחר מספר נוסעים</p>
            <svg width="100px" height="100px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="backarrowsvg" onclick="backfromStop()">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289L16.7071 11.2929C17.0976 11.6834 17.0976 12.3166 16.7071 12.7071L9.70711 19.7071C9.31658 20.0976 8.68342 20.0976 8.29289 19.7071C7.90237 19.3166 7.90237 18.6834 8.29289 18.2929L14.5858 12L8.29289 5.70711C7.90237 5.31658 7.90237 4.68342 8.29289 4.29289Z" fill="#000000"/>
            </svg>
            
        </div>
        <div id="noseaDefine" class="noselect pricer">
            <div class="biggerdiv">
                <p>נוסע יחיד - תעריף <span id="noseatitle">מלא</span></p>
                <p class="note">נסיעה עד <span id="distance"></span> ק"מ</p>
            </div>
            <div class="smallerdiv">
                <span id="price">0.0</span>₪
            </div>
        </div>
        <div id="extranoseaDefine" class="noselect pricer" style="display: none;">
            <div class="biggerdiv">
                <p>נוסעים נוספים - תעריף <span>מלא</span></p>
                <p class="note">נסיעה עד <span id="distanceForExtra"></span> ק"מ</p>
            </div>
            <div class="smallerdiv">
                <span id="priceForExtra">0.0</span>₪
            </div>
        </div>
        <div class="warning noselect" >
            <svg width="64px" height="64px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="SVGRepo_iconCarrier"> <path d="M12 7.01001V7.00002M12 17L12 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#e4ae53" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/> </g>
                
                </svg>
            <p><b id="extraNoseimW" style="display: none;">שים לב! כל נוסע נוסף יחויב תעריף מלא<br/></b>החיוב משוער, בסוף כל יום נחשב את התעריף הסופי, בהתבסס על שאר הנסיעות שלך.</p>
        </div>
        <div id="lastinfo">
            <div id="passengerCount">
                    <p class="noselect">מספר הנוסעים: </p>
                    <div>
                        <span id="numofnoseim" class="noselect">1</span>
                        <svg width="64px" height="64px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" fill="#000000" onclick="updatePrice(-1)">
                            <g id="SVGRepo_iconCarrier"> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"> <g id="minusCircleColor" sketch:type="MSLayerGroup" transform="translate(-516.000000, -1087.000000)" fill="#c3c3c3"> <path d="M532,1117 C524.268,1117 518,1110.73 518,1103 C518,1095.27 524.268,1089 532,1089 C539.732,1089 546,1095.27 546,1103 C546,1110.73 539.732,1117 532,1117 L532,1117 Z M532,1087 C523.163,1087 516,1094.16 516,1103 C516,1111.84 523.163,1119 532,1119 C540.837,1119 548,1111.84 548,1103 C548,1094.16 540.837,1087 532,1087 L532,1087 Z M538,1102 L526,1102 C525.447,1102 525,1102.45 525,1103 C525,1103.55 525.447,1104 526,1104 L538,1104 C538.553,1104 539,1103.55 539,1103 C539,1102.45 538.553,1102 538,1102 L538,1102 Z" id="minus-circle" sketch:type="MSShapeGroup"> </path> </g> </g> </g>
                        </svg>
                        <svg width="64px" height="64px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" fill="#000000"  onclick="updatePrice(1)">
                            <g id="SVGRepo_iconCarrier"> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"> <g id="plusCircleColor" sketch:type="MSLayerGroup" transform="translate(-464.000000, -1087.000000)" fill="#197cc0"> <path d="M480,1117 C472.268,1117 466,1110.73 466,1103 C466,1095.27 472.268,1089 480,1089 C487.732,1089 494,1095.27 494,1103 C494,1110.73 487.732,1117 480,1117 L480,1117 Z M480,1087 C471.163,1087 464,1094.16 464,1103 C464,1111.84 471.163,1119 480,1119 C488.837,1119 496,1111.84 496,1103 C496,1094.16 488.837,1087 480,1087 L480,1087 Z M486,1102 L481,1102 L481,1097 C481,1096.45 480.553,1096 480,1096 C479.447,1096 479,1096.45 479,1097 L479,1102 L474,1102 C473.447,1102 473,1102.45 473,1103 C473,1103.55 473.447,1104 474,1104 L479,1104 L479,1109 C479,1109.55 479.447,1110 480,1110 C480.553,1110 481,1109.55 481,1109 L481,1104 L486,1104 C486.553,1104 487,1103.55 487,1103 C487,1102.45 486.553,1102 486,1102 L486,1102 Z" id="plus-circle" sketch:type="MSShapeGroup"> </path> </g> </g> </g>
                        </svg>
                </div>
            </div>
            <div id="sumInfo" class="noselect">
                <div >סה"כ (חישוב משוער): </div> <div id="sumUp"><span id="sum">0.0</span>₪</div>
            </div>
            <button class="noselect">תקף נסיעה</button>
        </div>
    </div>
    
<script>

buspresets = {
    // kavim: "#03296a",
    kavim:"#8cbcd8",
    metropolin: "#f78f1e",
    egged: "#018369",
    dan:"#205cab",
    electra:"#7fb90d",
    superbus:"#003e7e",
    rakal:"#ea0000"
}

nosea = {
    hanaha:0.5,
    title:"נוער"
}
extraNoseim = 0;

function getDistance(origin, destination) {
    // return distance in meters
    console.log(origin,destination)
    var lon1 = toRadian(origin.longitude),
        lat1 = toRadian(origin.latitude),
        lon2 = toRadian(destination[0]),
        lat2 = toRadian(destination[1]);

    var deltaLat = lat2 - lat1;
    var deltaLon = lon2 - lon1;

    var a = Math.pow(Math.sin(deltaLat/2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(deltaLon/2), 2);
    var c = 2 * Math.asin(Math.sqrt(a));
    var EARTH_RADIUS = 6371;
    return c * EARTH_RADIUS * 1000;
}
function toRadian(degree) {
    return degree*Math.PI/180;
}


function backtoSelectia() {
    html5QrCode.stop();
    document.getElementById('secondscreen').style.display = "none";
    document.getElementById('firstscreen').style.display = "flex";
}

const html5QrCode = new Html5Qrcode("reader");
const qrCodeSuccessCallback = (decodedText, decodedResult) => {
    html5QrCode.stop();
    document.getElementById('secondscreen').style.display = "none";
    document.getElementById('thirdscreen').style.display = "block";
    
};
function backfromStops() {
    document.getElementById('secondscreen').style.display = "block";
    document.getElementById('thirdscreen').style.display = "none";
    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
}


const config = { fps: 10, qrbox: { width: window.innerWidth-50, height: window.innerHeight-50 } };

// If you want to prefer back camera

function go() {
    selection = document.getElementById("searchRes").value;
    //if nothing in selection
    if (selection == "") {
        alert("יש לבחור מסגרת");
        return;
    }
    selection = JSON.parse(selection)
    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
    document.getElementById("reader").innerHTML += `<div style="
    position: fixed;bottom: 24vh;width: 100vw;text-align: center;color: white;direction: rtl;font-family: system-ui;z-index:999;" id="help">שימו לב שהקוד ממוקד בתוך המסגרת. <br>הסריקה תתבצע באופן אוטומטי</div>`
    document.getElementById("secondscreen").style.display = "block";
    document.getElementById("firstscreen").style.display = "none";
    axxx= true
    var mone1 = 1
    var mone2 = -1
    var mosef = '0-1'
    var mone0 = 0
    var myFunc02 = function() {
    
        console.warn("a " + selection + mosef)
        fetch(`https://corsproxy.io/?https://www.markav.net/shapes/?q=${selection.RouteID}-${mosef}`)
        .then(response => {
            if (response.status !=500) {
                //clearInterval(intervalId);
                
                fetch(`https://corsproxy.io/?https://www.markav.net/shapes/?q=${selection.RouteID}-${mosef}`)
                .then(response => response.json())
                .then(data => {
                    processData(data);
                    //if selection.AgencyName includes "קווים" then color is buspresets.kavim, but if selection.AgencyName includes "מטרופולין" then color is buspresets.metropolin, and so on, "אגד" will be egged, "דן" will be dan and so on
                    switch (selection.AgencyName) {
                        case "קווים":
                            colorr = buspresets.kavim;
                            break;
                        case "מטרופולין":
                            colorr = buspresets.metropolin;
                            break;
                        case "דן":
                            colorr = buspresets.dan;
                            break;
                        case "אגד":
                            colorr = buspresets.egged;
                            break;
                        case "אלקטרה":
                            colorr = buspresets.electra;
                            break;
                        case "סופרבוס":
                            colorr = buspresets.superbus;
                            break;
                    }
                    document.querySelector('body').style.setProperty('--buscolor', colorr);
                    geojsonMarkerOptions.color = colorr
                    document.getElementById("busStopSelectionNumber").innerHTML = selection.RouteName
                    
                    L.geoJSON(data,{
                        style: function(feature) {
                        
                        if (feature.properties.class == "Bus stop") {
                            console.log("a")
                            return {
                                geojsonMarkerOptions
                            }
                        }

                    },
                    pointToLayer: function (feature, latlng) {
                        console.log(feature.properties.class);
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties.class == "Bus stop") {
                            console.log(feature.properties.class + " b");
                            layer.on('click', function (e) {
                                selectStop(feature);
                            });
                        }
                        }   
                    }).addTo(map);
                    var locator = map.locate({
                        setView:true,
                        watch:true
                    })
                    map.setView([32.0030, 34.8435], 12);
                });
            } else {
                
                // if (mone0 == 11) {
                if (mone2 == 10) {
                    mone1++
                    mone2 = 0
                    } else {
                        mone2++
                    }
                    mosef = `${mone1}-${mone2}`
                    console.log(mosef)
                // } else {
                //     mone0++
                //     mosef = mone0
                // }
                setTimeout(myFunc02(),200);
            }
        })
    
    };
    
    setTimeout(myFunc02(),200);
    

}



function processData(dataX) {
    //for each child that has propeties.class == "Bus Stop"
    for (let i = 0; i < dataX.features.length; i++) {
        if (dataX.features[i].properties.class == "Bus stop") {
            div = document.createElement("li");
            div.className = "stop";
            div.id = dataX.features[i].properties.id;
            div.innerHTML = `<p>${dataX.features[i].properties.name}</p><div id="extender"></div>`;
            div.onclick = function() {
                selectStop(dataX.features[i]);
            }
            div.onclick = function() {
                selectStop(dataX.features[i]);
            }
            document.getElementById("stops").appendChild(div)
        }
    }
}
price = 0.0;
Uprice = 0.0;
function selectStop(stop) {
    console.log(stop)
    console.log(getDistance(currentloc,stop.geometry.coordinates))
    document.getElementById("thirdscreen").style.display = "none";
    document.getElementById("fourthscreen").style.display = "block";
    document.getElementById("noseatitle").innerText = nosea.title;
    
    if (getDistance(currentloc,stop.geometry.coordinates) > 15000) {
        document.getElementById("distance").innerHTML = "40";
        price = 12.00;
        Uprice = price * nosea.hanaha;
        document.getElementById("price").innerText = Uprice.toFixed(2);
    } else {
        document.getElementById("distance").innerHTML = "15";
        price = 5.5;
        Uprice = price * nosea.hanaha;
        document.getElementById("price").innerText = Uprice.toFixed(2);
    }
    document.getElementById("sum").innerText = Uprice.toFixed(2);


}
function backfromStop() {
    document.getElementById("fourthscreen").style.display = "none";
    document.getElementById("thirdscreen").style.display = "block";
}


function updatePrice(addetive) {
    if (extraNoseim < 8 && addetive == 1) {
        extraNoseim++;
        document.getElementById("minusCircleColor").style.fill = "#197cc0"
        document.getElementById("plusCircleColor").style.fill = "#197cc0"
        document.getElementById("extranoseaDefine").style.display = "flex"
        document.getElementById("extraNoseimW").style.display = 'block'
        if (extraNoseim == 8) {
            document.getElementById("plusCircleColor").style.fill = "#c3c3c3"
        }
        
    } else if (extraNoseim > 0 && addetive == -1) {
        extraNoseim--;
        document.getElementById("minusCircleColor").style.fill = "#197cc0"
        document.getElementById("plusCircleColor").style.fill = "#197cc0"
        document.getElementById("extranoseaDefine").style.display = "flex"
        document.getElementById("extraNoseimW").style.display = 'block'
        if (extraNoseim == 0) {
                document.getElementById("minusCircleColor").style.fill = "#c3c3c3"
                document.getElementById("extranoseaDefine").style.display = "none"
                document.getElementById("extraNoseimW").style.display = 'none'
        }
    }
    document.getElementById("priceForExtra").innerText = (extraNoseim * price).toFixed(2)
    document.getElementById("sum").innerHTML = (Uprice + (extraNoseim * price)).toFixed(2)
    document.getElementById("numofnoseim").innerText = extraNoseim + 1
}



// Load GeoJSON data from a file (replace with your actual file path)
var geojsonMarkerOptions = {
    radius: 8,
    fillColor: "#FFFFFF",
    color: "#3388ff",
    weight: 2,
    opacity: 1, 
    fillOpacity: 1,
    stroke:true
};



lastsrc = ''
function searchKavim(input) {
    fetch("https://data.gov.il/api/3/action/datastore_search?resource_id=e6cfac2f-979a-44fd-b439-ecb116ec0b16&limit=15&q=" + input, {
        }).then(response => response.json())
        .then(data => {
           // alert('Total results found: ' + data.result.total)
           lastsrc = data.result.records
            console.log(data)
            document.getElementById("searchRes").innerHTML = ""
            for (i = 0; i < data.result.records.length; i++) {
                
                p = document.createElement("option")
                p.innerHTML = `קו ${data.result.records[i].RouteName} - ${data.result.records[i].OriginCityName} <-> ${data.result.records[i].DestinationCityName} <b>-</b> ${data.result.records[i].AgencyName}`
                p.value = JSON.stringify(data.result.records[i])
                 
                document.getElementById("searchRes").appendChild(p)
            }
        });
        }

var map = L.map('map').setView([32.0030, 34.8435], 12);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '',
    maxZoom: 18
}).addTo(map);



map.on('locationfound', function(ev){
currentloc = ev;
console.log(currentloc)
})
</script>
</body>
</html>